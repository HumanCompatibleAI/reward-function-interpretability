[![CircleCI](https://circleci.com/gh/HumanCompatibleAI/reward-preprocessing/tree/main.svg?style=svg&circle-token=5689f087396d3f526afd49f3af9d4b098560f79c)](https://circleci.com/gh/HumanCompatibleAI/reward-preprocessing/tree/main)
# Reward preprocessing
## Installation
First clone this repository.
We use [`poetry`](https://python-poetry.org/) to manage dependencies.
You will also need Mujoco. `mujoco_py` is installed as part of our
environment (see below) but its
[installation and troubleshooting instructions](https://github.com/openai/mujoco-py)
might still be helpful.
Once Mujoco is installed and has a license key, you can reproduce our environment with
```
poetry install
pip install git+https://github.com/HumanCompatibleAI/imitation
```
(run this command inside the cloned repo). This will automatically create a new
virtual environment.
Use `poetry shell` to start a shell inside this virtual environment.

TODO: the extra step for installing `imitation` is because I use it in editable mode, which `poetry` apparently doesn't yet support that well.
In the long term, `imitation` should just be part of `pyproject.toml`.

## Docker
You can also use our [Docker image](https://hub.docker.com/repository/docker/ejenner/reward_preprocessing)
instead of the installation procedure described above. However, note that the
Mujoco key file in `/root/.mujoco/mjkey.txt` is empty in the image, you will need
to enter a valid license key there.

If you use the `latest` tag of the image, you will get an image that already
includes the code and is ready to go (except for the Mujoco key). You can also mount
the code into the Docker image from your local disk instead (e.g. for development purposes).
In that case, we suggest you use `scripts/start_docker.sh`. More specifically:
- Set the `MUJOCO_KEY_URL` environment variable to a URL that returns a Mujoco key
  when accessed
- Set the `REWARD_PREPROCESSING_DIR` environment variable to the path to this
  repository on your machine
- Make sure you've pulled the `dependencies` tag of the Docker image
- If you have Docker set up such that it requires root privileges,
  you'll need to turn `docker run` in `scripts/start_docker.sh` into `sudo docker run`
- Now run `scrips/start_docker.sh`. This will create and start a Docker
  container and set up a few things (such as the Mujoco key). You then get
  an interactive shell inside the Docker container. This repository will be
  mounted to `/reward_preprocessing` inside the container.
  
Note: you musn't have a `.venv/` virtual environment inside this repository
if you want to mount it into the container this way. `poetry` will use the mounted repository otherwise.
By default, `poetry` creates virtual environments in a separate
location anyway, so if you followed our suggested setup above (or didn't create
a virtual environment on the host machine at all), you should be fine.
Alternatively, you can change 
[this setting](https://python-poetry.org/docs/configuration/#virtualenvsin-project)
to `false` on the Docker container (haven't tested that though).

`ci/docker.sh` is a helper script to build the Docker image, test it, and then
push it to DockerHub. You will need to set the `MUJOCO_KEY_URL` environment variable
again, e.g.:
```
MUJOCO_KEY_URL="https://..." ci/docker.sh
```
(the URL isn't needed to build the Docker image, but it's needed to test whether
Mujoco was installed correctly in the image).

## Running experiments
Main entry point is `scripts/interpret.sh` for reasonable defaults
or `src/reward_preprocessing/interpret.py` for more flexibility.

TODO: document this in more detail, as well as other scripts.

## Directories
`runs/` and `results/` are both in `.gitignore` and are meant to be used to
store artifacts. `runs/` is used for the Sacred `FileObserver`, so it contains
information about every single run. In contrast, `results/` is meant for
generated artifacts that are meant to be used by subsequent runs, such as trained
models or datasets of transition-reward pairs. It will only contain the versions
of these artifacts that are needed (e.g. the best/latest model), whereas `runs/`
will contain all the artifacts generated by past runs.

## Tests
Run
```
poetry run pytest
```
to run all available tests (or just run `pytest` if the environment is active).

## Code style and linting
`ci/code_checks.sh` contains checks for formatting and linting.
We recommend using it as a pre-commit hook:
```
ln -s ../../ci/code_checks.sh .git/hooks/pre-commit
```

To automatically change the formatting (rather than just checking it), run
```
ci/format_code.sh
```
Alternatively, you may want to configure your editor to run `black` and `isort` when saving a file.

Run `poetry run pytype` (or just `pytype` inside the `poetry` shell) to type check
the code base. This may take a bit longer than linting, which is why it's not part
of the pre-commit hook. It's still checked during CI though.
